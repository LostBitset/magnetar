<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Factors</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <script>
    let escapeMode = new Set();
    function newElement(el, tag) {
        el.innerText = el.innerText.slice(0, -1);
        let nextFragment = document.createElement(tag);
        el.parentNode.appendChild(nextFragment);
        let kSplit = k.split(":");
        let kNextFrag = kSplit[0] + kSplit[1] + parseInt(kSplit[2] + 1);
        nextFragment.setAttribute("data-mtar-ref", kNextFrag);
        nextFragment.setAttribute("contenteditable", true);
        nextFragment.oninput = () => up(nextFragment);
        nextFragment.focus();
    }
    function up(el) {
        let k = el.attributes["data-mtar-ref"].value;
        let last = el.innerText.at(-1);
        if (el.innerText.replaceAll("\n", "") === "") {
            el.remove();
        } else if (last === '\\') {
            escapeMode.add(k);
        } else if (escapeMode.has(k)) {
            fetch(`/__update__?k=${k}&v=${el.innerText.slice(0, -2) + last}`);
            escapeMode.delete(k);
        } else if (el.innerText.endsWith("\n\n")) {
            newElement(el, "p");
        } else {
            if (last === '`') {
                newElement(el, "pre");
            }
            fetch(`/__update__?k=${k}&v=${el.innerText}`)
        }
    }
    </script>
    <article>
        <h1 data-mtar-ref="Integration_Factors">Integration Factors</h1>
        <section>
            <h3 data-mtar-ref="Integration_Factors:Equation">Equation</h3>
            <p data-mtar-ref="Integration_Factors:Equation:0">So the equation goes here...</p>
        </section>
    </article>
</body>
</html>
